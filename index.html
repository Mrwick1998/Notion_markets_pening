<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BÃ¶rsenstatus â€“ DE-Sicht (MEZ/CEST)</title>
  <script src="https://unpkg.com/luxon@3/build/global/luxon.min.js"></script>
  <style>
    :root{
      --green:#17c964; --bg:transparent;
      --panel:rgba(255,255,255,.95); --text:#111; --muted:#666;
      --shadow:0 4px 12px rgba(0,0,0,.1);
    }
    @media (prefers-color-scheme: dark){
      :root{ --panel:rgba(24,24,24,.9); --text:#eee; --muted:#aaa; --shadow:0 5px 20px rgba(0,0,0,.6); }
    }
    html,body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:800px; margin:0 auto; padding:10px; text-align:center; }
    h1{ font-size:16px; margin:0 0 4px; }
    .sub{ margin:0 0 10px; color:var(--muted); font-size:12px; }
    .livebar{ display:flex; justify-content:center; align-items:center; gap:8px; font-size:10px; color:var(--muted); margin-bottom:12px; flex-wrap:wrap; }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; background:rgba(23,201,100,.18); border:1px solid rgba(23,201,100,.35); color:#022b14; font-size:10px; font-weight:800; }
    .pill .dot{ width:8px; height:8px; border-radius:50%; background:var(--green); }
    @keyframes pulse{0%{transform:scale(1)}70%{transform:scale(1.05)}100%{transform:scale(1)}} .pill.blink .dot{ animation:pulse 1.1s ease-out; }

    .grid{ display:flex; justify-content:center; flex-wrap:wrap; gap:10px; }

    .card{ background:var(--panel); border-radius:10px; box-shadow:var(--shadow); padding:8px; width:170px; }
    /* Statt ganze Karte zu verblassen, nur markierte Teile dimmen */
    .card.closed .dim{ opacity:.35; filter:grayscale(55%); }

    .flag{ width:100%; aspect-ratio:3/2; object-fit:cover; border-radius:6px; margin-bottom:6px; }

    .progress{ width:100%; height:6px; background:rgba(0,0,0,.08); border-radius:999px; overflow:hidden; margin:3px 0 4px; }
    .progress-bar{ height:100%; width:0%; transition:width .6s ease; }
    .progress-bar.open{ background:linear-gradient(90deg, rgba(23,201,100,.9), rgba(14,163,93,.9)); }
    .progress-bar.before, .progress-bar.after{ background:rgba(128,128,128,.3); }

    .pct{ font-size:10px; color:var(--muted); margin-bottom:6px; }

    .name{ font-weight:600; font-size:12px; margin-bottom:2px; }
    .badge{ font-weight:700; font-size:10px; padding:2px 6px; border-radius:999px; display:inline-flex; align-items:center; gap:4px; }
    .badge.open{ color:#0c5; }     /* grÃ¼nlich */
    .badge.closed{ color:#888; }   /* grau */

    .nextline{ font-size:11px; margin:4px 0 6px; }
    .nextline strong{ color:var(--text); }

    .meta{ font-size:10px; line-height:1.3; color:var(--muted); }
    .meta strong{ color:var(--text); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BÃ¶rsenstatus â€“ London â€¢ New York â€¢ Tokyo â€¢ Sydney</h1>
    <p class="sub">Zeiten aus deutscher Sicht (<strong>Europe/Berlin</strong>). Automatische Umstellung MEZ/CEST. Aktualisierung minÃ¼tlich.</p>

    <div class="livebar">
      <span id="live" class="pill"><span class="dot"></span> LIVE</span>
      <span id="updated">Zuletzt aktualisiert: â€“</span>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <script>
    const TARGET_TZ = "Europe/Berlin";
    const { DateTime, Duration } = luxon;
    const ms = d => d.toMillis();

    // Zeiten aus deutscher Sicht (MEZ & CEST)
    const EXCHANGES = [
      { key:"sydney",  name:"Sydney (ASX)",               flag:"https://flagcdn.com/w320/au.png",
        mez:{open:"23:00", close:"08:00"}, cest:{open:"00:00", close:"09:00"} }, // Ã¼ber Nacht
      { key:"tokyo",   name:"Tokyo Stock Exchange (TSE)", flag:"https://flagcdn.com/w320/jp.png",
        mez:{open:"01:00", close:"10:00"}, cest:{open:"02:00", close:"11:00"} },
      { key:"london",  name:"London Stock Exchange (LSE)",flag:"https://flagcdn.com/w320/gb.png",
        mez:{open:"09:00", close:"18:00"}, cest:{open:"10:00", close:"19:00"} },
      { key:"newyork", name:"New York (NYSE & Nasdaq)",   flag:"https://flagcdn.com/w320/us.png",
        mez:{open:"14:00", close:"23:00"}, cest:{open:"15:00", close:"00:00"} }  // Ã¼ber Nacht
    ];

    function parseHM(t){ const [h,m]=t.split(":").map(Number); return {hour:h, minute:m, second:0, millisecond:0}; }

    // Session-Fenster korrekt Ã¼ber Mitternacht; berÃ¼cksichtigt â€žgesternâ†’heuteâ€œ-Fenster
    function getWindowDE(ex, nowDE){
      const sch = nowDE.isInDST ? ex.cest : ex.mez;

      let openToday  = nowDE.set(parseHM(sch.open));
      let closeToday = nowDE.set(parseHM(sch.close));
      const crosses  = ms(closeToday) <= ms(openToday);
      if (crosses) closeToday = closeToday.plus({days:1});

      // Liegen wir im Fenster der VORNACHT?
      if (crosses){
        const openPrev  = openToday.minus({days:1});
        const closePrev = closeToday.minus({days:1});
        if (ms(nowDE) >= ms(openPrev) && ms(nowDE) <= ms(closePrev)){
          return { open: openPrev, close: closePrev };
        }
      }
      return { open: openToday, close: closeToday };
    }

    function stateNow(ex, nowDE){
      const {open, close} = getWindowDE(ex, nowDE);
      if (ms(nowDE) < ms(open))  return { state:'before', open, close };
      if (ms(nowDE) > ms(close)) return { state:'after',  open, close };
      return { state:'open', open, close };
    }

    function progressNow(ex, nowDE){
      const {state, open, close} = stateNow(ex, nowDE);
      if (state === 'before') return { pct:0, state, open, close };
      if (state === 'after')  return { pct:1, state, open, close };
      const total  = ms(close) - ms(open);
      const passed = ms(nowDE) - ms(open);
      return { pct: Math.max(0, Math.min(1, passed/total)), state, open, close };
    }

    function etaText(msLeft){
      if (msLeft < 0) msLeft = 0;
      const d = Duration.fromMillis(msLeft).shiftTo('hours','minutes').toObject();
      const h = Math.floor(d.hours || 0), m = Math.floor(d.minutes || 0);
      return `${h}h ${m}m`;
    }

    function nextChangeText(ex, nowDE){
      const {state, open, close} = stateNow(ex, nowDE);
      if (state === 'open'){
        return { label:'schlieÃŸt in', eta: etaText(ms(close) - ms(nowDE)) };
      }
      // nÃ¤chster Open (heute wenn noch davor, sonst morgen)
      let nextOpen = open;
      if (ms(nowDE) >= ms(open)) nextOpen = open.plus({days:1});
      return { label:'Ã¶ffnet in', eta: etaText(ms(nextOpen) - ms(nowDE)) };
    }

    function todaysLabel(ex, nowDE){
      const sch = nowDE.isInDST ? ex.cest : ex.mez;
      return `${sch.open} â€“ ${sch.close}`;
    }

    const grid  = document.getElementById('grid');
    const liveEl= document.getElementById('live');
    const updEl = document.getElementById('updated');

    function renderCard(ex, nowDE){
      const prog = progressNow(ex, nowDE);
      const openBool = prog.state === 'open';
      const nxt = nextChangeText(ex, nowDE);
      const pct = Math.round(prog.pct * 100);
      const pctLine =
        prog.state === 'open'
          ? `${pct}% der heutigen Session abgeschlossen`
          : (prog.state === 'before'
               ? `0% â€“ startet in ${nxt.eta}`
               : `100% â€“ Ã¶ffnet in ${nxt.eta}`);

      const badge = openBool
        ? `<span class="badge open">ðŸ’¼ OPEN</span>`
        : `<span class="badge closed">ðŸŒ™ CLOSED</span>`;

      const pClass = (prog.state === 'open') ? 'open' : (prog.state === 'before' ? 'before' : 'after');

      /* WICHTIG:
         - Alle â€ždimâ€œ-Elemente werden bei geschlossenen Karten ausgegraut.
         - Die .nextline bleibt IMMER klar sichtbar. */
      return `
        <div class="card ${openBool ? 'open' : 'closed'}">
          <img class="flag dim" src="${ex.flag}" alt="${ex.name}">
          <div class="progress dim"><div class="progress-bar ${pClass}" style="width:${pct}%;"></div></div>
          <div class="pct dim">ðŸ•’ ${pctLine}</div>
          <div class="name dim">${ex.name}</div>
          <div class="dim">${badge}</div>

          <div class="nextline"><strong>NÃ¤chster Wechsel:</strong> ${nxt.label} ${nxt.eta}</div>

          <div class="meta dim">
            <div><strong>Heute (DE):</strong> ${todaysLabel(ex, nowDE)}</div>
          </div>
        </div>
      `;
    }

    function update(){
      const nowDE = DateTime.now().setZone(TARGET_TZ);
      const dstText = nowDE.isInDST ? "CEST (Sommerzeit)" : "MEZ (Winterzeit)";
      liveEl.innerHTML = `<span class="dot"></span> LIVE Â· Aktuell: ${dstText}`;
      updEl.textContent = "Zuletzt aktualisiert: " + nowDE.toFormat("dd.LL.yyyy HH:mm:ss 'Uhr'");

      grid.innerHTML = EXCHANGES.map(ex => renderCard(ex, nowDE)).join("");
      liveEl.classList.add('blink'); setTimeout(()=>liveEl.classList.remove('blink'), 1000);
    }

    update();
    setInterval(update, 60*1000);
  </script>
</body>
</html>
