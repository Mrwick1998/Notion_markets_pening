<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Börsenstatus – DE-Sicht (MEZ/CEST)</title>
  <script src="https://unpkg.com/luxon@3/build/global/luxon.min.js"></script>
  <style>
    :root{
      --green:#17c964; --red:#f21361;
      --bg:transparent; --panel:rgba(255,255,255,.9);
      --text:#111; --muted:#666; --radius:10px; --shadow:0 5px 15px rgba(0,0,0,.1);
      --tooltip-bg: rgba(0,0,0,.85); --tooltip-text: #fff;
    }
    @media (prefers-color-scheme: dark){
      :root{ --panel:rgba(24,24,24,.9); --text:#eee; --muted:#aaa; --shadow:0 5px 20px rgba(0,0,0,.5);
             --tooltip-bg: rgba(255,255,255,.95); --tooltip-text:#111; }
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    .wrap{max-width:800px;margin:0 auto;padding:10px;text-align:center;}
    h1{font-size:16px;margin:0 0 4px;}
    .sub{margin:0 0 10px;color:var(--muted);font-size:12px;}

    .livebar{display:flex;align-items:center;justify-content:center;gap:10px;font-size:10px;color:var(--muted);margin-bottom:10px;flex-wrap:wrap;}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:rgba(23,201,100,.18);border:1px solid rgba(23,201,100,.35);color:#022b14;font-size:10px;font-weight:800;}
    .pill .dot{width:8px;height:8px;border-radius:50%;background:var(--green);}
    @keyframes pulse{0%{transform:scale(1)}70%{transform:scale(1.05)}100%{transform:scale(1)}}
    .pill.blink .dot{animation:pulse 1.1s ease-out;}
    .updated{margin-left:0;}

    /* Tooltip */
    .tip{position:relative; cursor:help; font-weight:700;}
    .tip::after{
      content: attr(data-tip);
      position:absolute; left:50%; transform:translateX(-50%); bottom:120%;
      background:var(--tooltip-bg); color:var(--tooltip-text);
      padding:6px 8px; border-radius:6px; white-space:nowrap; font-size:11px;
      opacity:0; pointer-events:none; transition:.15s ease; box-shadow:0 6px 18px rgba(0,0,0,.2);
    }
    .tip::before{
      content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:110%;
      border:6px solid transparent; border-top-color:var(--tooltip-bg); opacity:0; transition:.15s ease;
    }
    .tip:hover::after, .tip:hover::before{opacity:1;}

    .grid{display:flex;justify-content:center;flex-wrap:wrap;gap:10px;}
    .card{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:6px;border:2px solid transparent;width:150px;transition:border-color .2s ease;}
    .card.open{border-color:rgba(23,201,100,.85);}
    .card.closed{border-color:rgba(242,19,97,.85);}

    .flag{width:100%;aspect-ratio:3/2;object-fit:cover;border-radius:6px;margin-bottom:6px;display:block;}

    .progress{width:100%;height:6px;background:rgba(0,0,0,.08);border-radius:999px;overflow:hidden;margin:2px 0 8px;}
    .progress-bar{height:100%;width:0%;transition:width .6s ease;}
    .progress-bar.open{background:linear-gradient(90deg, rgba(23,201,100,.9), rgba(14,163,93,.9));}
    .progress-bar.before{background:rgba(242,19,97,.25);}
    .progress-bar.after{background:rgba(242,19,97,.85);}

    .name{font-weight:600;font-size:12px;margin-bottom:2px;}
    .badge{font-weight:700;font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid transparent;display:inline-block;}
    .badge.open{color:#022b14;background:rgba(23,201,100,.18);border-color:rgba(23,201,100,.3);}
    .badge.closed{color:#2b020f;background:rgba(242,19,97,.16);border-color:rgba(242,19,97,.3);}
    .meta{font-size:10px;line-height:1.3;color:var(--muted);}
    .meta strong{color:var(--text);}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Börsenstatus – London • New York • Tokyo • Sydney</h1>
    <p class="sub">Zeiten aus deutscher Sicht (<strong>Europe/Berlin</strong>). Automatische Umstellung MEZ/CEST. Aktualisierung minütlich. (Feiertage werden nicht berücksichtigt.)</p>

    <div class="livebar">
      <span id="live" class="pill"><span class="dot"></span> LIVE</span>
      <span id="dstLabel" class="tip" data-tip="CEST = Mitteleuropäische Sommerzeit · MEZ = Mitteleuropäische Zeit (Winterzeit)">–</span>
      <span id="updated" class="updated">Zuletzt aktualisiert: –</span>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <script>
    const TARGET_TZ = "Europe/Berlin";
    const DateTime = luxon.DateTime;

    // Zeiten fix aus deutscher Sicht (MEZ & CEST)
    // Übernacht-Sessions (close < open) werden erkannt und korrekt über Mitternacht geführt.
    const EXCHANGES = [
      {
        key:"sydney",
        name:"Sydney (ASX)",
        city:"Sydney",
        flag:"https://flagcdn.com/w320/au.png",
        mez:{ open:"23:00", close:"08:00" },   // über Mitternacht
        cest:{ open:"00:00", close:"09:00" }   // über Mitternacht
      },
      {
        key:"tokyo",
        name:"Tokyo Stock Exchange (TSE)",
        city:"Tokyo",
        flag:"https://flagcdn.com/w320/jp.png",
        mez:{ open:"01:00", close:"10:00" },
        cest:{ open:"02:00", close:"11:00" }
      },
      {
        key:"london",
        name:"London Stock Exchange (LSE)",
        city:"London",
        flag:"https://flagcdn.com/w320/gb.png",
        mez:{ open:"09:00", close:"18:00" },
        cest:{ open:"10:00", close:"19:00" }
      },
      {
        key:"newyork",
        name:"New York (NYSE & Nasdaq)",
        city:"New York",
        flag:"https://flagcdn.com/w320/us.png",
        mez:{ open:"14:00", close:"23:00" },
        cest:{ open:"15:00", close:"00:00" }  // über Mitternacht
      }
    ];

    function parseHM(t){ const [h,m]=t.split(":").map(Number); return {h, m}; }

    // Liefert das heutige Session-Fenster in DE-Zeit (mit Übernacht-Behandlung)
    function getTodayWindowDE(ex, nowDE){
      const isDST = nowDE.isInDST;
      const sch = isDST ? ex.cest : ex.mez;
      const {h:oh,m:om} = parseHM(sch.open);
      const {h:ch,m:cm} = parseHM(sch.close);

      let openToday  = nowDE.set({hour:oh, minute:om, second:0, millisecond:0});
      let closeToday = nowDE.set({hour:ch, minute:cm, second:0, millisecond:0});

      const crossesMidnight = closeToday <= openToday; // z.B. 23:00–08:00
      if (crossesMidnight) closeToday = closeToday.plus({days:1});

      // Falls wir gerade im Fenster der Vor-Nacht liegen (bei Übernacht)
      if (crossesMidnight){
        const openPrev  = openToday.minus({days:1});
        const closePrev = closeToday.minus({days:1});
        if (nowDE >= openPrev && nowDE <= closePrev){
          return { open: openPrev, close: closePrev, crosses:true, sch };
        }
      }
      return { open: openToday, close: closeToday, crosses: crossesMidnight, sch };
    }

    function isOpenNowDE(ex, nowDE){
      const w = getTodayWindowDE(ex, nowDE);
      const open = nowDE >= w.open && nowDE <= w.close;
      return { open, ...w };
    }

    // Fortschritt 0..1 + Statusklasse (before/open/after)
    function sessionProgressDE(ex, nowDE){
      const w = getTodayWindowDE(ex, nowDE);
      if (nowDE < w.open)  return { pct:0, state:'before', ...w };
      if (nowDE > w.close) return { pct:1, state:'after',  ...w };
      const total  = w.close.toMillis() - w.open.toMillis();
      const passed = nowDE.toMillis()   - w.open.toMillis();
      return { pct: Math.max(0, Math.min(1, passed/total)), state:'open', ...w };
    }

    // ETA-Format „Tage/Std/Min“
    function formatETA(ms){
      if (ms < 0) ms = 0;
      const d = luxon.Duration.fromMillis(ms).shiftTo('days','hours','minutes').toObject();
      const parts = [];
      if (d.days)  parts.push(`${Math.floor(d.days)}T`);
      if (d.hours) parts.push(`${Math.floor(d.hours)}h`);
      parts.push(`${Math.floor(d.minutes || 0)}m`);
      return parts.join(' ');
    }

    // „schließt in …“ / „öffnet in …“ (aus DE-Sicht)
    function nextChangeETA_DE(ex, nowDE){
      const st = isOpenNowDE(ex, nowDE);
      if (st.open){
        const eta = st.close.toMillis() - nowDE.toMillis();
        return { label:"schließt in", etaText: formatETA(eta) };
      } else {
        // Nächste Öffnung: heute (falls noch davor) sonst morgen
        const w = getTodayWindowDE(ex, nowDE);
        let nextOpen = w.open;
        if (nowDE >= w.open) nextOpen = w.open.plus({days:1});
        const eta = nextOpen.toMillis() - nowDE.toMillis();
        return { label:"öffnet in", etaText: formatETA(eta) };
      }
    }

    // Anzeige „Heute (DE): HH:mm – HH:mm“ (zeigt den aktiven MEZ/CEST-Slot)
    function todaysLabelDE(ex, nowDE){
      const isDST = nowDE.isInDST;
      const sch = isDST ? ex.cest : ex.mez;
      return `${sch.open} – ${sch.close}`;
    }

    const grid  = document.getElementById('grid');
    const liveEl= document.getElementById('live');
    const updEl = document.getElementById('updated');
    const dstEl = document.getElementById('dstLabel');

    function cardHTML(ex, st, labelToday, nxt, nowTxt, prog){
      const badge = st.open ? `<span class="badge open">OPEN</span>` : `<span class="badge closed">CLOSED</span>`;
      const cls   = st.open ? 'card open' : 'card closed';
      const pct   = Math.round(prog.pct*100);
      const pClass = prog.state === 'open' ? 'open' : (prog.state === 'after' ? 'after' : 'before');
      return `
        <div class="${cls}" id="card-${ex.key}">
          <img class="flag" src="${ex.flag}" alt="Flagge ${ex.city}">
          <div class="progress" aria-label="Fortschritt Handelssitzung">
            <div class="progress-bar ${pClass}" style="width:${pct}%;"></div>
          </div>
          <div class="name">${ex.name}</div>
          ${badge}
          <div class="meta">
            <div><strong>Heute (DE):</strong> ${labelToday}</div>
            <div><strong>Jetzt (DE):</strong> ${nowTxt}</div>
            <div><strong>Nächster Wechsel:</strong> ${nxt.label} ${nxt.etaText}</div>
          </div>
        </div>
      `;
    }

    function update(){
      const nowDE = DateTime.now().setZone(TARGET_TZ);
      const nowTxt = nowDE.toFormat("EEE, dd.LL, HH:mm");

      // LIVE & DST-Label inkl. Tooltip
      const dstText = nowDE.isInDST ? "CEST (Sommerzeit)" : "MEZ (Winterzeit)";
      liveEl.innerHTML = `<span class="dot"></span> LIVE · Aktuell: ${dstText}`;
      dstEl.textContent = "ℹ️";
      dstEl.setAttribute("aria-label", "Info zu MEZ/CEST");
      // Tooltip-Text ist im CSS via data-tip gesetzt

      // Karten rendern
      grid.innerHTML = EXCHANGES.map(ex=>{
        const st    = isOpenNowDE(ex, nowDE);
        const lab   = todaysLabelDE(ex, nowDE);
        const nxt   = nextChangeETA_DE(ex, nowDE);
        const prog  = sessionProgressDE(ex, nowDE);
        return cardHTML(ex, st, lab, nxt, nowTxt, prog);
      }).join("");

      updEl.textContent = "Zuletzt aktualisiert: " + nowDE.toFormat("dd.LL.yyyy HH:mm:ss 'Uhr'");
      liveEl.classList.add('blink'); setTimeout(()=>liveEl.classList.remove('blink'),1100);
    }

    update();
    setInterval(update, 60*1000);
  </script>
</body>
</html>
